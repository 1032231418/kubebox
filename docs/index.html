<!doctype html>
<html>

<head>
  <link rel="stylesheet" href="xterm/xterm.css" />
  <script src="xterm/xterm.js"></script>
  <script src="xterm/fit.js"></script>
  <script src="kubebox.js"></script>

  <style>
    html {
      height: 100%;
    }

    body {
      height: 100%;
      margin: 0;
      background-color: black;
    }

    @font-face {
      font-family: 'Fira Code';
      src: url('FiraCode-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    .terminal {
      font-family: 'Fira Code', Courier New, Courier, monospace;
      font-variant-ligatures: none;
      font-size: 12px;
    }

    .overlay {
      position: fixed;
      z-index: 1000;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      transition: opacity 500ms;
      visibility: hidden;
    }
    .popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 10px;
      background: #000;
      border:1px solid #fff;
      font-family: 'Fira Code', Courier New, Courier, monospace;
      font-size: 12px;
      color: white;
      box-shadow: 3px 3px 0 0 #aaa;
    }
    .popup .cancel {
      border: 0 none;
      padding: 0 1em 0 1em;
      font-family: inherit;
      border-radius: unset;
      background-color: unset;
      color: unset;
      font-size: unset;
    }
    .popup .cancel:hover,
    .popup .cancel:focus {
      background-color: grey;
      outline: none;
    }
    .popup .file {
      width: 0.1px;
      height: 0.1px;
      opacity: 0;
      overflow: hidden;
      position: absolute;
      z-index: -1;
    }
    .popup .file + label {
      padding: 0 1em 0 1em;
    }
    .popup .file:focus + label,
    .popup .file + label:hover {
      background-color: grey;
    }

  </style>
</head>

<body>
  <div id="terminal"></div>

  <div id="popup" class="overlay">
    <div class="popup">
      <div>Select a file to import from:</div>
      <div style="text-align: right; margin-top: 1em">
        <input id="file" name="file" type="file" class="file" />
        <label for="file">Select...</label>
        <input id="cancel" type="button" value="Cancel" class="cancel">
      </div>
    </div>
  </div>

  <script>
    var blessed = require('blessed');
    var Kubebox = require('kubebox');

    // Should ideally be inherited from require('events').EventEmitter
    Terminal.prototype.listenerCount = function (type) {
      return this.listeners(type).length;
    };
    Object.defineProperty(Terminal.prototype, 'columns', {
      get: function () {
        return this.cols;
      }
    });
    // By-pass Xterm.js event queue as Blessed expect a single event to be sent
    // to the data handler. This actually happens on iOS with the mouseover and
    // mouseup events.
    Terminal.prototype.send = function (data) {
      this.handler(data);
    }

    var term = new Terminal();
    term.open(document.getElementById('#terminal'), true);
    term.fit();
    term.isTTY = true;

    var program = blessed.program({ input: term, output: term, tput: false });

    var screen = blessed.screen({
      program       : program,
      Terminal      : 'xterm-256color',
      resizeTimeout : 10,
      forceUnicode  : true,
      // smartCSR   : true,
      dockBorders   : true,
      autoPadding   : true,
      warnings      : true
    });

    window.onresize = function () {
      term.fit();
    };
    // seems required by Safari
    window.onload = function () {
      term.fit();
    }
    screen.on('resize', function () {
      term.fit();
    });

    // checking the Master API environment variable
    var env = new XMLHttpRequest();
    env.onreadystatechange = function () {
      if (this.readyState === 4) {
        switch (this.status) {
          case 200:
            kubebox(JSON.parse(this.responseText).KUBEBOX_MASTER_API);
            break;
          case 404:
            kubebox();
            break;
          default:
            console.log('Error getting Kubebox environment');
            kubebox();
        }
      }
    };
    env.open('GET', '/env');
    env.setRequestHeader('Accept', 'application/json');
    env.send();

    function kubebox(url) {
      var kubebox = new Kubebox(screen, url);

      // Kube config import modal popup
      var popup  = document.getElementById('popup');
      var file   = document.getElementById('file');
      var cancel = document.getElementById('cancel');
      var input  = document.querySelector('input');
      popup.addEventListener('keydown', function (e) {
        if (e.which === 27) {
          e.preventDefault();
          popup.style.visibility = 'hidden';
          term.focus();
        }
      });
      cancel.addEventListener('click', function () {
        popup.style.visibility = 'hidden';
        term.focus();
      });
      // trap focus into the modal
      cancel.addEventListener('keydown', function (e) {
        if (e.which === 9) {
          e.preventDefault();
          file.focus();
        } else if (e.which === 38) {
          file.focus();
        }
      });
      file.addEventListener('keydown', function (e) {
        if (e.which === 9 && e.shiftKey) {
          e.preventDefault();
          cancel.focus();
        } else if (e.which === 40) {
          cancel.focus();
        }
      });
      input.addEventListener('change', function () {
        const file_reader = new FileReader();
        file_reader.onload = function () {
          kubebox.loadKubeConfig(file_reader.result);
          popup.style.visibility = 'hidden';
          term.focus();
        }
        // TODO: support file references in the kube config (certificates for example)
        file_reader.readAsText(input.files[0], 'utf8');
      });
      kubebox.on('kubeConfigImport', function () {
        popup.style.visibility = 'visible';
        file.focus();
      });
    }
  </script>
</body>

</html>