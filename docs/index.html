<!doctype html>
<html>

<head>
  <link rel="stylesheet" href="xterm/xterm.css" />
  <div id="upload" class="terminal">
    <label for="file">Upload Kubernetes configuration file</label>
    <input name="file" type="file">
  </div>
  <script src="xterm/xterm.js"></script>
  <script src="xterm/fit.js"></script>
  <script src="kubebox.js"></script>

  <style>
    html {
      height: 100%;
    }

    body {
      height: 100%;
      margin: 0;
      background-color: black;
    }

    @font-face {
      font-family: 'Fira Code';
      src: url('FiraCode-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    .terminal {
      font-family: 'Fira Code', Courier New, Courier, monospace;
      font-variant-ligatures: none;
      font-size: 12px;
    }

    #upload {
      text-align: center;
      color: white;
    }
  </style>
</head>

<body>
  <div id="terminal"></div>
  <script>
    var blessed = require('blessed');
    var Kubebox = require('kubebox');

    // Should ideally be inherited from require('events').EventEmitter
    Terminal.prototype.listenerCount = function (type) {
      return this.listeners(type).length;
    };
    Object.defineProperty(Terminal.prototype, 'columns', {
      get: function () {
        return this.cols;
      }
    });
    // By-pass Xterm.js event queue as Blessed expect a single event to be sent
    // to the data handler. This actually happens on iOS with the mouseover and
    // mouseup events.
    Terminal.prototype.send = function (data) {
      this.handler(data);
    }

    var term = new Terminal();
    // TODO: find a way to disable the extra right padding for the scrollbar
    term.open(document.getElementById('#terminal'), true);
    term.fit();
    term.isTTY = true;

    var program = blessed.program({ input: term, output: term, tput: false });

    var screen = blessed.screen({
      program       : program,
      Terminal      : 'xterm-256color',
      resizeTimeout : 10,
      forceUnicode  : true,
      // smartCSR   : true,
      dockBorders   : true,
      autoPadding   : true,
      warnings      : true
    });

    window.onresize = function () {
      term.fit();
    };
    // seems required by Safari
    window.onload = function () {
      term.fit();
    }
    screen.on('resize', function () {
      term.fit();
    });

    var kubebox = new Kubebox(screen);
    var input = document.querySelector('input');
    input.addEventListener('change', function upload(){
      const file_reader = new FileReader();
      file_reader.onload = function(){
        kubebox = new Kubebox(screen, file_reader.result)
      }
      //TODO: support file references in the kube config (certificates for example)
      file_reader.readAsText(input.files[0], 'utf8');
    });

  </script>
</body>

</html>